; FIND PRIMES	3 OCTOBER 2021

; CP/M
TPA	EQU	100H
EXIT	EQU	0
BDOS	EQU	5
COUT	EQU	2
SOUT	EQU	9

; ASCII CHARACTERS
CR	EQU	0DH	; CARRIAGE RETURN
LF	EQU	0AH	; LINE FEED

	ORG	TPA

	LXI	SP,STAK	; SET UP THE STACK

STR:	DB	'THIS IS A TEST$'
	LXI	H,STR
	CALL	WRTS
;	LXI	H,20000	; TEST DIVISION ROUTINE
;	LXI	D,10000
;	CALL	LNGDIV
;	CALL	CTAB
;	CALL	WRTS
;	XCHG
;	CALL	CTAB
;	CALL	WRTS
;	MOV	A,B
;	CALL	CTAB
;	CALL	WRTS

;	LXI	H,519BH	; TEST 16 BIT SUBSTRACTION
;	LXI	D,3B16H
;	CALL	SUB16
;	CALL	CTAB
;	CALL	WRTS

	CALL	PRIMES	; SHOW SOME PRIMES

	JMP	EXIT

CURR:	DW	2	; CURRENT NUMBER
CURR1:	DW	0	; CURRENT DIVIDEND
PRIMES:	LXI	H,1	; CALCULATE NEXT DIVIDEND
PL2:	INX	H
	SHLD	CURR1
	XCHG
	LHLD	CURR	; CHECK IF TOO HIGH
	CALL	CMP16
	JZ	PFND	; PRIME FOUND!
	LHLD	CURR1	; CALCULATE REMINDER
	XCHG
	LHLD	CURR
	CALL	DIV16
	LXI	H,0	; IS IT 0?
	CALL	CMP16
	JZ	PNXT	; NOT A PRIME - NEXT
	LHLD	CURR1	; MOVING ON
	JMP	PL2
PNXT:	LHLD	CURR	; NEXT POTENTIAL PRIME
	INX	H
	SHLD	CURR
	XCHG
	LXI	H,1000	; TOO BIG?
	CALL	CMP16
	RC		; THEN LEAVE
	JMP	PRIMES	; ELSE, MOVING ON
PFND:	LHLD	CURR	; PRINT PRIME
	CALL	CTAB
	CALL	WRTS
	JMP	PNXT
	
; WRITE STRING
WRTS:	PUSH	B	; SAVE REGISTERS
	PUSH	D
	PUSH	H
	MVI	C,SOUT
	MOV	D,H
	MOV	E,L
	CALL	BDOS
	MVI	A,CR	; END OF LINE
	CALL	WRTC
	MVI	A,LF
	CALL	WRTC
	POP	H	; RESTORE REGISTERS
	POP	D
	POP	B
	RET

; WRITE CHARACTER
WRTC:	PUSH	B	; SAVE REGISTERS
	PUSH	D
	PUSH	H
	MVI	C,COUT
	MOV	E,A
	CALL	BDOS
	POP	H	; RESTORE REGISTERS
	POP	D
	POP	B
	RET

; SET UP THE STACK SPACE
	DS	64
STAK:	DB	0	; TOP OF THE STACK

